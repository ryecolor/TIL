# pjt-01. API 활용

<br>

## Index
0. 금주 학습 내용
1. 데이터 추출 - KEY값 출력
2. 데이터 추출 - 특정 영역 출력
3. 데이터 가공 - KEY값 변경
4. 데이터 가공 - 데이터 추가
5. 생성형 AI 활용 자율 학습
6. 학습 이후 느낀 점

<br>
<br>

> 프로젝트 목표
``` python
- 'OpenWeatherMap API'를 사용하여 날씨 데이터를 받고, 원하는 형태로 출력 및 가공한다.
- 'Generative AI' ChatGPT를 활용하여 자유롭게 날씨 데이터를 선택 추출한다.
```

<br>

### 0. 금주 학습 내용
---

<br>

> 용어 이해

- 서버
  - 요청을 받으면 처리해 주거나, 요청대로 원하는 값을 돌려 주는 역할
  - 다양한 방식의 클라이언트 요청을 수행하기 위해 `API` 프로그램 제작
- 클라이언트
  - 서버에게 정보를 요청하는 역할

---

- API
  - 클라이언트의 코드와 서버 사이를 연결해 주는 프로그램
  - `Open API` : 데이터를 오픈하여 공유하는 API
  - `API KEY` : 무차별적 접근을 방지하기 위해 데이터 접근인에게 발급하는 키
  - 일부 Open API는 사용량 제한 존재

---

- pip
  - python install package, 파이썬 패키지 관리 프로그램
  - `pip list` : 설치된 패키지 확인 기능

---

- JSON
  - JavaScript Object Notation, 자바스크립트 객체 표기법
  - 데이터를 저장하거나 전송할 때 많이 사용되는 경량의 텍스트 기반의 데이터 형식
  - 데이터는 `중괄호({})`로 둘러싸인 `키-값 쌍의 집합`으로 표현됨
  - 키 = 문자열 / 값 = 다양한 데이터 유형을 가질 수 있으며 각각의 값은 쉼표(,)로 구분됨


<br>

> 사용 모듈
``` python
import requests
from pprint import pprint
```
- requests
  - 클라이언트의 요청을 서버에 전달하는 함수
  - Open API 사용을 위해 import
- pprint
  - 기존 print() 함수 정렬의 가시성 제고

<br>

> 기본 코드 구조
``` python
response = requests.get(url).json()
```
- url
  - 요청을 보내는 서버의 주소
- get() 함수
  - 해당 서버(url)에 데이터를 달라고 요청을 보내는 함수
- .json() 함수
  - 내부의 데이터를 JSON 형태로 변환해 주는 함수

<br>

> 참고 사항
``` python
response = requests.get(url).json()
```
- 파싱
  - Parsing, 데이터를 의미 있는 구조로 분석하고 해석하는 과정
- json.loads()
  - JSON 형식의 문자열을 파싱하여 Python Dictionary로 변환

<br>
<br>

### 1. `데이터 추출` - KEY값 출력
---

<br>

> 날씨 데이터의 응답을 JSON 형태로 변환 후 아래와 같이 Key 값만 출력하세요.

```python
import requests
from pprint import pprint


def get_weather(api_key):
    city = "Seoul,KR"
    url = f'http://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}'

    # 요구사항에 맞도록 이곳의 코드를 수정합니다.
    response = requests.get(url).json()
    pprint(response)
    # 데이터 중 key 값만 출력
    result = response.keys()
    return result


# 아래 코드는 수정하지 않습니다.
if __name__ == '__main__':
    # 여러분의 OpenWeatherMap API 키를 설정하세요
    api_key = '-'
    result = get_weather(api_key)
    pprint(result)
```

<br>
<br>

### 2. `데이터 추출` - 특정 영역 출력
---

<br>

> 날씨 데이터 중 Key 값이 `"main"`인 데이터와 `"weather"`인 데이터만 새로운 `dictionary`에 담아 출력하세요.

```python
import requests
from pprint import pprint


def get_weather(api_key):
    city = "Seoul,KR"
    url = f'http://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}'
    response = requests.get(url).json()
    # 요구사항에 맞도록 이곳의 코드를 수정합니다.
    result = {
        'main': response['main'],
        'weather_data': response['weather']
    }
    return result


# 아래 코드는 수정하지 않습니다.
if __name__ == '__main__':
    # 여러분의 OpenWeatherMap API 키를 설정하세요
    api_key = '-'

    result = get_weather(api_key)
    pprint(result)
```

- 조건에 해당하는 값만 반환할 때 `딕셔너리['Key']` 형태 사용

<br>
<br>

### 3. `데이터 가공` - KEY값 변경
---

<br>

> 2번의 결과를 활용하여 Key 값들을 한글로 변경한 딕셔너리를 반환하세요.

```python
import requests
from pprint import pprint

def get_weather(api_key):
    city = "Seoul,KR"
    url = f'http://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}'
    response = requests.get(url).json()
    # 요구사항에 맞도록 이곳의 코드를 수정합니다.
    result = {
        'main': response['main'],
        'weather_data': response['weather']
    }

    main = {
        '기압': result['main']['pressure'],
        '습도': result['main']['humidity'],
        '온도': result['main']['temp'],
        '체감온도': result['main']['feels_like'],
        '최고온도': result['main']['temp_max'],
        '최저온도': result['main']['temp_min'],
    }
    weather_data = {
        '요약': result['weather_data'][0]['description'],
        '아이콘': result['weather_data'][0]['icon'],
        '식별자': result['weather_data'][0]['id'],
        '핵심': result['weather_data'][0]['main']
    }
    real_result = {
        '기본': main,
        '날씨': weather_data
    }
    return real_result


# 아래 코드는 수정하지 않습니다.
if __name__ == '__main__':
    # 여러분의 OpenWeatherMap API 키를 설정하세요
    api_key = '-'

    result = get_weather(api_key)
    pprint(result)

```

- 딕셔너리 내 딕셔너리의 key 값까지 수정 필요
- `순차적`으로 내부 딕셔너리 key 값 우선 수정 후 딕셔너리 병합하여 반환

<br>
<br>

### 4. `데이터 가공` - 데이터 추가
---

<br>

> 3번의 결과를 활용하여 섭씨 온도 데이터를 추가하세요.

```python
import requests
from pprint import pprint

def get_weather(api_key):
    city = "Seoul,KR"
    url = f'http://api.openweathermap.org/data/2.5/weather?q={city}&appid={api_key}'
    response = requests.get(url).json()
    # 요구사항에 맞도록 이곳의 코드를 수정합니다.
    result = {
        'main': response['main'],
        'weather_data': response['weather']
    }

    main = {
        '기압': result['main']['pressure'],
        '습도': result['main']['humidity'],
        '온도': result['main']['temp'],
        '체감온도': result['main']['feels_like'],
        '최고온도': result['main']['temp_max'],
        '최저온도': result['main']['temp_min'],
    }
    weather_data = {
        '요약': result['weather_data'][0]['description'],
        '아이콘': result['weather_data'][0]['icon'],
        '식별자': result['weather_data'][0]['id'],
        '핵심': result['weather_data'][0]['main']
    }
    real_result = {
        '기본': main,
        '날씨': weather_data
    }

    real_result['기본']['온도 (섭씨)'] = str(fahrenheit_to_celsius(real_result['기본']['온도']))[:6]
    real_result['기본']['체감온도 (섭씨)'] = str(fahrenheit_to_celsius(real_result['기본']['체감온도']))[:6]
    real_result['기본']['최고온도 (섭씨)'] = str(fahrenheit_to_celsius(real_result['기본']['최고온도']))[:6]
    real_result['기본']['최저온도 (섭씨)'] = str(fahrenheit_to_celsius(real_result['기본']['최저온도']))[:6]
    return real_result

def fahrenheit_to_celsius(fahrenheit):
    celsius = (fahrenheit - 32) * 5 / 9
    return celsius

# 아래 코드는 수정하지 않습니다.
if __name__ == '__main__':
    # 여러분의 OpenWeatherMap API 키를 설정하세요
    api_key = '-'

    result = get_weather(api_key)
    pprint(result)

```

- 섭씨 온도 변환을 위해 `파이썬 함수` 검색
- 함수 `fahrenheit_to_celsius()` 활용
``` python
def fahrenheit_to_celsius(fahrenheit):
    celsius = (fahrenheit - 32) * 5 / 9
    return celsius
```

<br>
<br>

### 5. `생성형 AI` 활용 자율 학습
---

<br>

> 생성형 AI를 활용하여 자유롭게 데이터를 수집하고, 원하는 동작을 설정하여 정답을 얻어 보세요.

<br>

``` python
너는 'API 전문가'로서 나에게 친절하게 설명해 주어야 해. 질문에 '잘 답변하면 너에게 팁을 줄게.' 그렇지만 '틀린 답을 준다면 그때는 네게 벌을 줄 거야.' 그럼 질문할게. OpenWeatherMap API를 알고 있니? 알고 있다면 OpenWeatherMap API의 엔드포인트를 알려 줘.
```
- Prompt Engineering 활용
  - GPT에게 `역할` 부여
  - 좋은 답변 출력 시의 `보상` 언급
  - 나쁜 답변 출력 시의 `체벌` 언급

<br>

``` python
'3일 후' 한국 '각 지역의 날씨'를 알기 위해서는 어떻게 요청을 보내야 할까?
```
- 정보를 얻기 위한 `질문` 입력

<br>

```python
# 코드 ------------------------------------------------------------------

import requests  # requests 라이브러리를 임포트합니다.
from datetime import datetime, timedelta  # datetime과 timedelta를 임포트합니다.

# OpenWeatherMap API 키
api_key = "-"  # OpenWeatherMap API 키를 입력합니다.

# 한국 주요 도시들의 위도와 경도
cities = {
    "Seoul": {"lat": 37.5665, "lon": 126.9780},  # 서울
    "Busan": {"lat": 35.1796, "lon": 129.0756},  # 부산
    "Daegu": {"lat": 35.8722, "lon": 128.6025},  # 대구
    "Incheon": {"lat": 37.4563, "lon": 126.7052},  # 인천
    "Gwangju": {"lat": 35.1595, "lon": 126.8526},  # 광주
    "Daejeon": {"lat": 36.3504, "lon": 127.3845},  # 대전
    "Ulsan": {"lat": 35.5384, "lon": 129.3114}  # 울산
}

# 3일 후 날짜 계산
target_date = datetime.utcnow() + timedelta(days=3)  # 현재 UTC 시간에서 3일을 더한 날짜를 계산합니다.
target_date_str = target_date.strftime("%Y-%m-%d")  # 날짜를 문자열 형식으로 변환합니다.

# 각 도시의 3일 후 날씨 데이터를 저장할 딕셔너리 초기화
weather_data = {}  # 결과를 저장할 딕셔너리를 초기화합니다.

# 각 도시의 날씨 데이터를 가져와서 딕셔너리에 저장
for city, coords in cities.items():  # 각 도시의 이름과 좌표를 반복합니다.
    # 5일/3시간 예보 데이터 요청 URL
    url = f"http://api.openweathermap.org/data/2.5/forecast?lat={coords['lat']}&lon={coords['lon']}&appid={api_key}&units=metric"  # API 요청 URL을 구성합니다.
    
    # API 요청 보내기
    response = requests.get(url)  # API 요청을 보냅니다.
    
    # JSON 응답 파싱
    data = response.json()  # JSON 형식의 응답을 파싱합니다.
    
    # 3일 후의 날씨 데이터 찾기
    for forecast in data["list"]:  # 예보 데이터를 반복합니다.
        if target_date_str in forecast["dt_txt"]:  # 예보 시간에 3일 후 날짜가 포함되어 있는지 확인합니다.
            summary = {
                "datetime": forecast["dt_txt"],  # 예보 시간
                "temperature": forecast["main"]["temp"],  # 기온
                "weather": forecast["weather"][0]["description"],  # 날씨 설명
                "humidity": forecast["main"]["humidity"],  # 습도
                "wind_speed": forecast["wind"]["speed"]  # 풍속
            }
            weather_data[city] = summary  # 각 도시의 요약 정보를 딕셔너리에 저장합니다.
            break  # 3일 후의 첫 번째 데이터를 찾으면 반복을 종료합니다.

# 결과 출력
for city, summary in weather_data.items():  # 각 도시의 이름과 요약 정보를 반복합니다.
    print(f"Weather in {city} on {summary['datetime']}:")  # 도시의 이름과 예보 시간을 출력합니다.
    print(f"Temperature: {summary['temperature']}°C")  # 기온을 출력합니다.
    print(f"Weather: {summary['weather']}")  # 날씨 설명을 출력합니다.
    print(f"Humidity: {summary['humidity']}%")  # 습도를 출력합니다.
    print(f"Wind Speed: {summary['wind_speed']} m/s")  # 풍속을 출력합니다.
    print()  # 줄 바꿈을 출력합니다.



# 코드 실행 결과 ---------------------------------------------------------

# Weather in Seoul on 2024-07-22 00:00:00:
# Temperature: 25.96°C
# Weather: light rain
# Humidity: 87%
# Wind Speed: 2.4 m/s

# Weather in Busan on 2024-07-22 00:00:00:
# Temperature: 26.83°C
# Weather: broken clouds
# Humidity: 85%
# Wind Speed: 3.44 m/s

# Weather in Daegu on 2024-07-22 00:00:00:
# Temperature: 28.12°C
# Weather: broken clouds
# Humidity: 79%
# Wind Speed: 1.8 m/s

# Weather in Incheon on 2024-07-22 00:00:00:
# Temperature: 25.06°C
# Weather: light rain
# Humidity: 91%
# Wind Speed: 3.43 m/s

# Weather in Gwangju on 2024-07-22 00:00:00:
# Temperature: 27.83°C
# Weather: broken clouds
# Humidity: 81%
# Wind Speed: 2.35 m/s

# Weather in Daejeon on 2024-07-22 00:00:00:
# Temperature: 26.18°C
# Weather: light rain
# Humidity: 87%
# Wind Speed: 1.31 m/s

# Weather in Ulsan on 2024-07-22 00:00:00:
# Temperature: 29.54°C
# Weather: scattered clouds
# Humidity: 67%
# Wind Speed: 3.5 m/s
```

<br>
<br>

### 6. 학습 이후 `느낀 점`
---

<br>

- 추상적으로 알고 있던 `API의 개념`을 완전히 이해했습니다.

- `requests`, `pprint` 등 유용한 모듈을 활용하여 실습하는 것에 성공했습니다.

- `생성형 AI` 활용 시 비약적인 시간 단축과 완벽한 코드 생성을 경험할 수 있었습니다.